<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>

<body>
  <script src="https://cdn.bootcss.com/async/2.6.0/async.js"></script>
  <script>
    const fn1 = opts => (conf) => {
      conf.a = 1
      console.log('fn1')
      return conf
    }

    const fn2 = opts => (conf) => {
      conf.b = 2
      conf.v = opts.v

    }

    const fn3 = opts => (conf) => {
      console.log('fn3')
      conf.c = 3
    }

    const fn4 = opts => (conf, next) => {
      console.log('fn4')
      conf.d = 4
      setTimeout(() => {
        next()
      })
    }

    const unset = s => s === undefined || s === null


    class F {
      constructor(conf = {}) {
        this.conf = conf
        this.queue = []
      }
      fn1(opts) {

        this.queue.push(fn1(opts))

        return this
      }
      fn2(opts) {

        this.queue.push(fn2(opts))

        return this
      }
      fn3(opts) {

        this.queue.push(fn3(opts))

        return this
      }
      fn4(opts) {
        this.queue.push(fn4(opts))
        return this
      }
      async() {
        this._async = true
        return this
      }
      value() {
        if (this._async) {
          return new Promise((resolve, reject) => {
            async.waterfall(toAsyncQueue(this.queue, this.conf), (err, res) => {
              resolve(res)
            })
          })
        } else {
          console.log(this.queue)
          return this.queue.reduce((data, fn) => {
            console.log(fn)
            const res = fn(data)
            return res ? fn(data) : data
          }, this.conf)
        }
      }


    }

    const test = (arg, cb) => {
      console.log(arg)
      // cb(5)
    }
    test('3', val => {
      console.log(5)
    })
  </script>
</body>

</html>